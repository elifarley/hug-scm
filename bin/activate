test -e "$HOME"/.hug-scm || {
  echo "$HOME/.hug-scm is missing. Before activating Hug, you must install it by running:"
  echo "  make install"
  exit 1
}

. "$HOME"/.hug-scm
export HUG_HOME PATH="$HUG_HOME/bin:$HUG_HOME/git-config/bin:$PATH:$HOME/.hug-deps/bin"
alias h=hug
alias g=hug

# Hug bash completion
if [[ -r "$HUG_HOME/completions/hug-completion.bash" ]]; then
  source "$HUG_HOME/completions/hug-completion.bash"
fi

complete -F _hug h

# Worktree switching function - this can change the current directory
# The underlying git-wt script outputs WORKTREE_PATH:/path/to/worktree for shell integration
wt() {
    local output
    local worktree_path

    # Capture all output from git-wt
    output=$(git-wt "$@")
    local exit_code=$?

    # If git-wt failed, return its exit code
    if [[ $exit_code -ne 0 ]]; then
        echo "$output" >&2
        return $exit_code
    fi

    # Extract worktree path from output
    worktree_path=$(echo "$output" | grep "^WORKTREE_PATH:" | cut -d: -f2-)

    # If no worktree path found, just show the output (likely help/info)
    if [[ -z "$worktree_path" ]]; then
        echo "$output"
        return 0
    fi

    # If worktree path exists and is a directory, switch to it
    if [[ -d "$worktree_path" ]]; then
        cd "$worktree_path" || {
            echo "Failed to change to worktree directory: $worktree_path" >&2
            return 1
        }
        # Show current context after switching (filter out the WORKTREE_PATH line)
        echo "$output" | grep -v "^WORKTREE_PATH:"

        local current_branch
        current_branch=$(git branch --show-current 2>/dev/null || echo "detached")
        echo "âœ“ Switched to worktree: ${worktree_path/#$HOME/~}"
        echo "  Current branch: $current_branch"
    else
        echo "Worktree directory not found: $worktree_path" >&2
        return 1
    fi
}

# Hug Fish completion

test -r "$HUG_HOME/completions/hug.fish" && \
  mkdir -p ~/.config/fish/completions && \
  \cp -f "$HUG_HOME/completions/hug.fish" "$HOME"/.config/fish/completions/

: Exit code set to 0

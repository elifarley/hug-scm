test -e "$HOME"/.hug-scm || {
  echo >&2 "$HOME/.hug-scm is missing. Before activating Hug, you must install it by running:"
  echo >&2 "  make install"
  return 1
}

. "$HOME"/.hug-scm
export HUG_HOME PATH="$HUG_HOME/bin:$HUG_HOME/git-config/bin:$PATH:$HOME/.hug-deps/bin"
alias h=hug
alias g=hug

# Hug bash completion
if [[ -r "$HUG_HOME/completions/hug-completion.bash" ]]; then
  source "$HUG_HOME/completions/hug-completion.bash"
fi

complete -F _hug h

# Worktree switching function - this can change the current directory
# The underlying git-wt script outputs WORKTREE_PATH:/path/to/worktree for shell integration
wt() {
    local output
    local worktree_path

    # Check if we have arguments (non-interactive mode)
    if [[ $# -eq 0 ]]; then
        # Interactive mode - need to show prompts to user
        # Use a temporary file to capture just WORKTREE_PATH while letting other output pass through
        local temp_file=$(mktemp)
        git-wt "$@" | tee "$temp_file"
        local exit_code=${PIPESTATUS[0]}

        # Extract worktree path if it exists
        worktree_path=$(grep "^WORKTREE_PATH:" "$temp_file" | cut -d: -f2-)
        rm -f "$temp_file"

        # If git-wt failed, just return the exit code (tee already showed the error)
        if [[ $exit_code -ne 0 ]]; then
            return $exit_code
        fi
    else
        # Non-interactive mode with arguments - can capture output safely
        output=$(git-wt "$@" 2>&1)
        local exit_code=$?

        # If git-wt failed, show the error and return its exit code
        if [[ $exit_code -ne 0 ]]; then
            echo "$output" >&2
            return $exit_code
        fi

        # Extract worktree path from output
        worktree_path=$(echo "$output" | grep "^WORKTREE_PATH:" | cut -d: -f2-)
    fi

    # If no worktree path found, user cancelled or requested help/info
    if [[ -z "$worktree_path" ]]; then
        return 0
    fi

    # If worktree path exists and is a directory, switch to it
    if [[ -d "$worktree_path" ]]; then
        cd "$worktree_path" || {
            echo "Failed to change to worktree directory: $worktree_path" >&2
            return 1
        }
        # Show current context after switching (filter out the WORKTREE_PATH line)
        echo "$output" | grep -v "^WORKTREE_PATH:"

        local current_branch
        current_branch=$(git branch --show-current 2>/dev/null || echo "detached")
        echo "âœ“ Switched to worktree: ${worktree_path/#$HOME/~}"
        echo "  Current branch: $current_branch"
    else
        echo "Worktree directory not found: $worktree_path" >&2
        return 1
    fi
}

# Hug Fish completion

test -r "$HUG_HOME/completions/hug.fish" && \
  mkdir -p ~/.config/fish/completions && \
  \cp -f "$HUG_HOME/completions/hug.fish" "$HOME"/.config/fish/completions/

: Exit code set to 0

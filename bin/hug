#!/usr/bin/env bash
# Part of the Hug tool suite
# Main dispatcher - detects repository type and delegates to appropriate SCM

# Set HUG_HOME if not already set (fallback derivation)
if [[ -z "${HUG_HOME:-}" ]]; then
  script_dir="$(cd "$(dirname "$0")" && pwd)"
  HUG_HOME="$(cd "$script_dir/../.." && pwd)"
fi
export HUG_HOME

# Handle clone command (outside repository)
if [[ "${1:-}" == "clone" ]]; then
    shift
    vcs=""
    auto_detected=false

    # Parse --git or --hg flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --git)
                vcs="git"
                shift
                ;;
            --hg)
                vcs="hg"
                shift
                ;;
            *)
                break
                ;;
        esac
    done

    if [[ $# -eq 0 ]]; then
        cat <<EOF
Usage: hug clone [--git|--hg] <url> [dir] [options]

Clone a Git or Mercurial repository. Auto-detects VCS from URL or prompts if ambiguous.
Use --git or --hg to force a specific VCS. Options are passed through to the underlying tool.
EOF
        exit 1
    fi

    url="$1"
    shift

    dir=""
    if [[ $# -gt 0 && $1 != -* ]]; then
        dir="$1"
        shift
    fi
    declare -a options=("$@")

    if [[ -z "$vcs" ]]; then
        auto_detected=true
        # Auto-detect from URL
        if [[ "$url" == *.git ]]; then
            vcs="git"
        elif [[ "$url" == *.hg ]] || echo "$url" | grep -q "hg\."; then
            vcs="hg"
        else
            # Prompt with gum if available, else fallback to read
            if command -v gum >/dev/null 2>&1; then
                vcs_choice=$(gum choose --header "Select VCS for '$url':" "Git" "Mercurial")
                vcs=$([[ "$vcs_choice" == "Git" ]] && echo "git" || echo "hg")
            else
                choice=''
                read -rp "Ambiguous VCS for '$url'. (g)it or (h)g? " choice
                vcs=$([[ ${choice,,} == g* ]] && echo "git" || echo "hg")
            fi
        fi
    fi

    if [[ "$auto_detected" == true ]]; then
        vcs_name=$([[ "$vcs" == "git" ]] && echo "Git" || echo "Mercurial")
        echo "Detected: $vcs_name"
    fi

    # Validate VCS availability
    if ! command -v "$vcs" >/dev/null 2>&1; then
        echo "Error: '$vcs' command not found in PATH. Please install $vcs." >&2
        exit 1
    fi

    # Execute clone
    if "$vcs" clone "$url" ${dir:+"$dir"} "${options[@]}"; then
        cloned_dir="${dir}"
        if [[ -z "$cloned_dir" ]]; then
            cloned_dir=$(basename "${url%.*}")
        fi
        echo "âœ“ Cloned successfully to '$cloned_dir'."
        cd "$cloned_dir" && hug s
    fi
    exit $?
fi

# Detect repository type and dispatch
if git rev-parse --git-dir >/dev/null 2>&1; then
    # Git repository detected
    test "${1:-help}" = help && exec git hughelp "${@:2}"
    # GIT_TRACE_SETUP=1 to show diagnostic messages
    exec git "$@"
elif hg root >/dev/null 2>&1; then
    # Mercurial repository detected
    test "${1:-help}" = help && {
        echo "Hug SCM - Mercurial mode"
        echo "Usage: hug <command> [options]"
        echo ""
        echo "Common commands:"
        echo "  s        - Show status"
        echo "  a        - Add files"
        echo "  c        - Commit changes"
        echo "  b        - Switch bookmark/branch"
        echo "  l        - Show log"
        echo "  w        - Working directory operations"
        exit 0
    }
    
    HG_CONFIG_BIN="$HUG_HOME/hg-config/bin"
    
    # Check if we have a custom hg command for this
    if [[ -n "${1:-}" && -x "$HG_CONFIG_BIN/hg-$1" ]]; then
        exec "$HG_CONFIG_BIN/hg-$1" "${@:2}"
    else
        # Fall back to standard hg command
        exec hg "$@"
    fi
else
    echo "Error: Not in a Git or Mercurial repository" >&2
    echo "" >&2
    echo "Hug SCM supports both Git and Mercurial repositories." >&2
    echo "Please run this command from within a repository." >&2
    [[ -z "${HUG_HOME:-}" ]] && echo "Note: If paths are incorrect, ensure HUG_HOME is set to the Hug installation root." >&2
    exit 1
fi

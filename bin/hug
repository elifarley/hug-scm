#!/usr/bin/env bash
# Part of the Hug tool suite
# Main dispatcher - detects repository type and delegates to appropriate SCM

# Set HUG_HOME if not already set (fallback derivation)
if [[ -z "${HUG_HOME:-}" ]]; then
  script_dir="$(cd "$(dirname "$0")" && pwd)"
  HUG_HOME="$(cd "$script_dir/../.." && pwd)"
fi
export HUG_HOME

# Handle commands that work outside repository
if [[ "${1:-}" == "clone" ]]; then
    shift
    exec "$HUG_HOME/bin/hug-clone" "$@"
fi

if [[ "${1:-}" == "init" ]]; then
    shift
    exec "$HUG_HOME/bin/hug-init" "$@"
fi

# Detect repository type and dispatch
if git rev-parse --git-dir >/dev/null 2>&1; then
    # Git repository detected
    test "${1:-help}" = help && exec git hughelp "${@:2}"
    # GIT_TRACE_SETUP=1 to show diagnostic messages
    exec git "$@"
elif hg root >/dev/null 2>&1; then
    # Mercurial repository detected
    test "${1:-help}" = help && {
        echo "Hug SCM - Mercurial mode"
        echo "Usage: hug <command> [options]"
        echo ""
        echo "Common commands:"
        echo "  s        - Show status"
        echo "  a        - Add files"
        echo "  c        - Commit changes"
        echo "  b        - Switch bookmark/branch"
        echo "  l        - Show log"
        echo "  w        - Working directory operations"
        exit 0
    }
    
    HG_CONFIG_BIN="$HUG_HOME/hg-config/bin"
    
    # Check if we have a custom hg command for this
    if [[ -n "${1:-}" && -x "$HG_CONFIG_BIN/hg-$1" ]]; then
        exec "$HG_CONFIG_BIN/hg-$1" "${@:2}"
    else
        # Fall back to standard hg command
        exec hg "$@"
    fi
else
    echo "Error: Not in a Git or Mercurial repository" >&2
    echo "" >&2
    echo "Hug SCM supports both Git and Mercurial repositories." >&2
    echo "Please run this command from within a repository." >&2
    [[ -z "${HUG_HOME:-}" ]] && echo "Note: If paths are incorrect, ensure HUG_HOME is set to the Hug installation root." >&2
    exit 1
fi

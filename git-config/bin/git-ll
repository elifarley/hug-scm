#!/usr/bin/env bash
CMD_BASE="$(readlink -f "$0" 2>/dev/null || greadlink -f "$0")" || CMD_BASE="$0"; CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit; do . "$CMD_BASE/../lib/$f"; done
set -euo pipefail

show_help() {
  cat << 'EOF'
hug ll: Log commits with detailed formatting (graph, date, author, message).

USAGE:
    hug ll [options] [<revision-range>] [-- <path>]

OPTIONS:
    -<n>           Show last n commits (e.g., -10)
    --all          Show all branches
    --json         Output as JSON (machine-readable)
    --with-stats   Include file change statistics (JSON mode only)
    --no-body      Omit commit message body (JSON mode only)
    -h, --help     Show this help

DESCRIPTION:
    Displays commit log with graph visualization, short hash, date, author,
    and commit message. Default output is human-readable with color formatting.
    Use --json for machine-readable output suitable for automation.

EXAMPLES:
    hug ll                         # Show commits on current branch
    hug ll -10                     # Show last 10 commits
    hug ll --all                   # Show all branches
    hug ll --json                  # Output as JSON
    hug ll --json --with-stats     # JSON with file change stats
    hug ll --json --no-body        # JSON with subject only (faster)
    hug ll --json --with-stats --no-body  # Combined flags
    hug ll main..feature           # Commits in feature not in main

JSON OUTPUT (GitHub-compatible + Hug enhancements):
    {
      "commits": [
        {
          "sha": "full_hash",
          "sha_short": "short_hash",
          "author": {
            "name": "...",
            "email": "...",
            "date": "ISO8601",
            "date_relative": "2 hours ago"
          },
          "committer": {
            "name": "...",
            "email": "...",
            "date": "ISO8601",
            "date_relative": "2 hours ago"
          },
          "message": "subject\n\nbody",
          "subject": "subject line",
          "body": "body text",
          "tree": {"sha": "tree_hash"},
          "parents": [{"sha": "parent_hash"}],
          "refs": ["HEAD", "main"],
          "stats": {"files_changed": 3, "insertions": 10, "deletions": 5}
        }
      ],
      "summary": {
        "total_commits": 5,
        "date_range": {"earliest": "...", "latest": "..."}
      }
    }

SEE ALSO:
    hug l        : Simpler one-line log
    hug la       : Log all branches
    hug lp       : Log with patches
    hug lf       : Search commits by message
EOF
}

# Parse flags
json_output=false
with_stats=false
no_body=false
git_args=()

while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help)
      show_help
      exit 0
      ;;
    --json)
      json_output=true
      shift
      ;;
    --with-stats)
      with_stats=true
      shift
      ;;
    --no-body)
      no_body=true
      shift
      ;;
    --all)
      git_args+=("--all")
      shift
      ;;
    -[0-9]*)
      git_args+=("$1")
      shift
      ;;
    *)
      git_args+=("$1")
      shift
      ;;
  esac
done

check_git_repo

if $json_output; then
  # JSON output mode
  # Always use Python helper for consistent parsing (handles multi-line commit messages)

  # Strategy: Use git log with simple separators, parse in Python
  # Format fields with a unique separator
  # Note: with --numstat, the format is: "<format>%n%n<numstat lines>%n"
  # Use newline as commit separator since numstat already includes newlines
  field_sep='|~|'
  # Format: hash|~|short|~|author_name|~|author_email|~|committer_name|~|committer_email|~|author_date|~|author_date_rel|~|committer_date|~|committer_date_rel|~|tree|~|subject|~|body|~|parents|~|refs
  format="%H${field_sep}%h${field_sep}%an${field_sep}%ae${field_sep}%cn${field_sep}%ce${field_sep}%aI${field_sep}%ar${field_sep}%cI${field_sep}%cr${field_sep}%T${field_sep}%s${field_sep}%B${field_sep}%P${field_sep}%D"

  # Delegate to Python helper for parsing
  python_helper="$CMD_BASE/../lib/python/log_json.py"

  # Build Python helper args
  python_args=()
  $with_stats && python_args+=("--with-stats")
  $no_body && python_args+=("--no-body")

  # Run git log with optional --numstat
  if $with_stats; then
    git log --format="${format}" --numstat "${git_args[@]}" 2>/dev/null | \
      python3 "$python_helper" "${python_args[@]}"
  else
    git log --format="${format}" "${git_args[@]}" 2>/dev/null | \
      python3 "$python_helper" "${python_args[@]}"
  fi

else
  # Human-readable output (fallback to existing alias behavior)
  git log --graph --pretty=log1 --date=short "${git_args[@]}"
fi

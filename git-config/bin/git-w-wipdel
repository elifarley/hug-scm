#!/usr/bin/env bash
# Assume HUG_HOME is set (exported by hug or environment)
# Import only needed library files
. "$HUG_HOME/git-config/lib/hug-terminal"
. "$HUG_HOME/git-config/lib/hug-output"
. "$HUG_HOME/git-config/lib/hug-gum"
. "$HUG_HOME/git-config/lib/hug-git-repo"
. "$HUG_HOME/git-config/lib/hug-git-branch"
set -euo pipefail  # Exit on error, undefined vars, pipe failures
# Part of the Hug tool suite

PROG_NAME="hug w wipdel"

show_help() {
  cat <<'EOF'
hug w wipdel: Delete a WIP branch created via `hug w wip` (no integration).

USAGE:
  hug w wipdel [OPTIONS] [WIP_BRANCH]

OPTIONS:
  -f, --force      Force delete the branch even if not fully merged.
  -h, --help       Show this help message and exit.

DESCRIPTION:
  Deletes a WIP/YY-MM-DD/HHmm.slug branch without merging/integrating its changes.
  Use when the temp work is worthless or abandoned. With no branch argument,
  presents an interactive picker (requires gum). By default attempts a safe delete
  (like `hug bdel`); use --force to drop unmerged work.

  For integrating temp work before deletion, use 'hug w unwip' instead.

EXAMPLES:
  hug w wipdel
  hug w wipdel WIP/24-10-05/1430.draftfeature
  hug w wipdel --force WIP/24-10-05/1430.draftfeature

TIPS:
  - If unsure, inspect the branch with 'hug l <wip_branch>' before deleting.
  - If you pushed the WIP branch, delete it remotely with 'hug bdelr <wip_branch>'.
EOF
}

usage_error() {
  printf '%s: %s\n\n' "$PROG_NAME" "$1" >&2
  show_help >&2
  exit 1
}

select_wip_branch() {
  # Use library function to get WIP branch details
  declare -a branches=() hashes=() subjects=()
  
  if ! compute_wip_branch_details branches hashes subjects 'refs/heads/WIP/'; then
    error "$PROG_NAME: No WIP branches found."
  fi

  if ! gum_available; then
    printf 'Available WIP branches:\n'
    for i in "${!branches[@]}"; do
      printf '  %s\n' "${branches[$i]}"
    done
    error "$PROG_NAME: Interactive mode requires 'gum' to be installed. Provide the branch explicitly (e.g., hug w wipdel WIP/24-10-05/1430.draftfeature) or install gum: https://github.com/charmbracelet/gum"
  fi

  # Prepare formatted options with branch details
  local -a formatted_options=()
  
  for i in "${!branches[@]}"; do
    local branch="${branches[$i]}"
    local hash="${hashes[$i]}"
    local subject="${subjects[$i]}"
    
    # Format: branch (hash) subject
    local formatted="${branch} ${YELLOW}${hash}${NC} ${GREY}${subject}${NC}"
    formatted_options+=("$formatted")
  done
  
  # Use gum filter for selection
  local gum_height
  gum_height=$((${#formatted_options[@]} < 13 ? ${#formatted_options[@]} + 2 : 15))
  
  local selection
  selection=$(printf '%s\n' "${formatted_options[@]}" | \
    gum filter --placeholder="Select WIP branch to delete..." \
                --height="$gum_height" \
                --no-strip-ansi \
                --reverse || true)
  
  if [ -z "$selection" ]; then
    info "Cancelled."
    exit 0
  fi
  
  # Extract branch name (first word). Assumes branch names have no spaces.
  local branch_name="${selection%% *}"
  printf '%s\n' "$branch_name"
}

force_delete=false
branch_arg=""

while (($#)); do
  case "$1" in
    -h|--help)
      show_help
      exit 0
      ;;
    -f|--force)
      force_delete=true
      ;;
    --)
      shift
      if (($# > 1)); then
        usage_error "Provide at most one branch name."
      fi
      if (($# == 1)); then
        branch_arg="$1"
      fi
      break
      ;;
    -*)
      usage_error "Unknown option '$1'."
      ;;
    *)
      if [ -n "$branch_arg" ]; then
        usage_error "Provide only one branch name."
      fi
      branch_arg="$1"
      ;;
  esac
  shift || break
done

check_git_repo

branch_selected="$branch_arg"
if [ -z "$branch_selected" ]; then
  branch_selected="$(select_wip_branch)"
fi

branch="$(trim_message "$branch_selected")"
if [ -z "$branch" ]; then
  error "$PROG_NAME: No WIP branch specified."
fi

if ! git rev-parse --verify --quiet "refs/heads/$branch"; then
  error "$PROG_NAME: Branch '$branch' does not exist."
fi

current_branch="$(git branch --show-current)"
if [ "$branch" = "$current_branch" ]; then
  error "$PROG_NAME: Cannot delete the currently checked-out branch '$branch'. Switch branches first."
fi

if [[ "$branch" != WIP/* ]]; then
  warn "$PROG_NAME: Branch '$branch' is not prefixed with WIP/; deleting anyway."
fi

if [ "$force_delete" = true ]; then
  hug bdelf "$branch"
else
  hug bdel "$branch"
fi

#!/usr/bin/env bash
CMD_BASE="$(readlink -f "$0" 2> /dev/null || greadlink -f "$0")" || CMD_BASE="$0"
CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit; do . "$CMD_BASE/../lib/$f"; done
set -euo pipefail # Exit on error, undefined vars, pipe failures
# Part of the Hug tool suite

show_help() {
  cat << EOF
h undo: Make HEAD walk back some commits while keeping their changes unstaged. Uncommitted changes are preserved.

USAGE:
    hug h undo [N|COMMIT] [-u, --upstream] [-t, --temporal TIME] [--quiet] [--force]

OPTIONS:
    -u, --upstream  Sets the target to upstream remote tip after read-only preview/confirmation (discards local-only commits; no fetch)
    -t, --temporal TIME
                    Specify commits by time instead of count/commit
                    TIME can be relative (e.g., "3 days ago", "1 week ago")
                    or absolute (e.g., "2024-01-15", "2024-01-15 10:30")
                    Reference point is HEAD's commit time
    --quiet         Suppress output (sets HUG_QUIET=T)
    --force         Skip confirmation prompts (use with caution)

DESCRIPTION:
    Moves HEAD to target. With -u, runs a read-only preview/confirmation before discarding local-only commits to sync with remote tip.
    With -t/--temporal, moves HEAD to the first commit at or after the specified time.

EXAMPLES:
    # Uncommitted changes are preserved in all examples below:
    hug h undo -u                # Moves HEAD to upstream, keep local changes unstaged
    hug h undo 3                 # Moves HEAD last 3 commits
    hug h undo a1b2c3            # Moves HEAD after specified commit
    hug h undo 3 --force         # Skip confirmation
    hug h undo -t "3 days ago"   # Move HEAD to first commit from 3 days ago
    hug h undo -t "1 week ago"   # Move HEAD to first commit from 1 week ago

SEE ALSO:
    hug h back    Make HEAD walk back some commits while keeping their changes staged

NOTES:
    All your edits are preserved, but the entire staging area is cleared.
    If you need to preserve staging, use 'hug h back' instead.
    Untracked and ignored files are never affected.
EOF
}

# Parse common flags (--quiet, --force, -h|--help)
eval "$(parse_common_flags "$@")"

# Parse temporal flag
eval "$(parse_temporal_flag "$@")"

# Parse remaining custom flags
upstream=false
target_arg=""
while [[ $# -gt 0 ]]; do
  case "$1" in
  -u | --upstream)
    upstream=true
    shift
    ;;
  *)
    target_arg="$1"
    shift
    ;;
  esac
done

check_git_repo

if $upstream; then
  # Use DRY helper for validation, then handle upstream-specific logic
  target=$(resolve_target_with_temporal "$upstream" "$temporal_spec" "$target_arg" 'HEAD~1') || exit 1

  # handle_upstream_operation performs a read-only preview/confirmation and echoes the upstream commit.
  if [[ ${HUG_FORCE:-} == true ]]; then
    target=$(handle_upstream_operation "undoing")
  elif has_staged_changes || has_unstaged_changes; then
    target=$(handle_upstream_operation "undoing")
  else
    info "No staged or unstaged changes detected; skipping confirmation."
    target=$(HUG_FORCE=true handle_upstream_operation "undoing")
  fi
else
  # Use DRY helper for validation and target resolution
  target=$(resolve_target_with_temporal "$upstream" "$temporal_spec" "$target_arg" 'HEAD~1') || exit 1

  # Handle root commit scenario (target doesn't exist because we're at the first commit)
  if ! git rev-parse --verify --quiet "$target" > /dev/null 2>&1 && is_at_root_commit; then
    # Show preview of the root commit
    if [[ ${HUG_QUIET:-} != T ]]; then
      printf 'Commits to be affected:\n' >&2
      hug ll HEAD~0 >&2
      printf '\nPreview: changes in 1 commit:\n' >&2
      git diff --stat --root HEAD >&2
    fi

    should_prompt=true
    if [[ ${HUG_FORCE:-} == true ]]; then
      should_prompt=false
    elif ! has_staged_changes && ! has_unstaged_changes; then
      should_prompt=false
      info "No staged or unstaged changes detected; skipping confirmation."
    fi

    if $should_prompt; then
      prompt_confirm_warn "Undo root commit? [y/N]: "
    fi

    reset_root_commit "mixed"
    info "Undone root commit (changes preserved as untracked)."
    exit 0
  fi

  # Handle command-specific preview and confirmation
  handle_standard_operation "undo" "$target"

  should_prompt=true
  if [[ ${HUG_FORCE:-} == true ]]; then
    should_prompt=false
  elif ! has_staged_changes && ! has_unstaged_changes; then
    should_prompt=false
    info "No staged or unstaged changes detected; skipping confirmation."
  fi

  if $should_prompt; then
    prompt_confirm_warn "Undo commits back to $(git rev-parse --short "$target")? [y/N]: "
  fi
fi

git reset --mixed "$target"
info "Moved HEAD back to $target to undo commits (uncommitted changes preserved)."

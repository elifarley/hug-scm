#!/usr/bin/env bash
CMD_BASE="$(readlink -f "$0" 2> /dev/null || greadlink -f "$0")" || CMD_BASE="$0"
CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit hug-select-files output_json_status; do . "$CMD_BASE/../lib/$f"; done # Load common constants and functions
set -euo pipefail                                                                                     # Exit on error, undefined vars, pipe failures

# Part of the Hug tool suite

# Enhanced status: shows detailed file list with color-coded status, then summary

# Early exit if not in Git repo
check_git_repo

# Parse arguments to determine what to show
include_untracked=false
json_output=false
quiet=false
if [[ ${HUG_QUIET:-} == T ]]; then
  quiet=true
fi
pathspecs=()

for arg in "$@"; do
  case "$arg" in
  --json)
    json_output=true
    ;;
  --long | -u | --untracked-files=all)
    include_untracked=true
    ;;
  -uno | --untracked-files=no)
    include_untracked=false
    ;;
  -q | --quiet)
    quiet=true
    ;;
  *)
    # Treat remaining arguments as pathspecs
    pathspecs+=("$arg")
    ;;
  esac
done

# Build list_files_with_status options
list_opts=("--staged" "--unstaged")
if $include_untracked; then
  list_opts+=("--untracked")
fi

# Add pathspecs if provided
if [[ ${#pathspecs[@]} -gt 0 ]]; then
  list_opts+=("${pathspecs[@]}")
fi

# TODO list files sorted by reverse status text (so that `S:*` files appear last, closer to the cursor line after the command has finished printing a lot of lines. The second field to sort should be the file path.

# JSON output mode
if $json_output; then
  output_json_status "${list_opts[@]}"
else
  # Show enhanced file list if there are any changes
  if ! list_files_with_status "${list_opts[@]}" 2> /dev/null; then
    # No files found - show appropriate message
    if $include_untracked; then
      if [[ ${#pathspecs[@]} -gt 0 ]]; then
        pathspec_list=""
        printf -v pathspec_list "'%s' " "${pathspecs[@]}"
        info "No staged, unstaged, or untracked files matching ${pathspec_list% } found."
      else
        info "No staged, unstaged, or untracked files."
      fi
    else
      if [[ ${#pathspecs[@]} -gt 0 ]]; then
        pathspec_list=""
        printf -v pathspec_list "'%s' " "${pathspecs[@]}"
        info "No staged or unstaged files matching ${pathspec_list% } found."
      else
        info "No staged or unstaged files."
      fi
    fi
  fi

  # Show summary line (unless quiet mode)
  if ! $quiet; then
    exec hug s
  fi
fi

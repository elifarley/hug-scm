#!/usr/bin/env bash
CMD_BASE="$(readlink -f "$0" 2> /dev/null || greadlink -f "$0")" || CMD_BASE="$0"
CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit hug-git-show; do . "$CMD_BASE/../lib/$f"; done
set -euo pipefail

# Part of the Hug tool suite

show_help() {
  cat << 'EOF'
hug sh: Show commit(s) with file statistics.

USAGE:
    hug sh [N|-N|<commit-ref>|<range>] [OPTIONS]

ARGUMENTS:
    N               Steps back from HEAD (0-999) → shows commit at HEAD~N (0 → HEAD)
    -N              Range of N commits (1-999) → shows HEAD~N..HEAD
    <commit-ref>    Commit reference (default: HEAD)
    <range>         Commit range (e.g., main..HEAD)

OPTIONS:
    -q, --quiet     Suppress headers (also honors HUG_QUIET env var)
    --llm           Output in LLM-friendly XML format
    --stat          Show file statistics (explicit override)
    --no-stat       Hide file statistics (default: show for both formats)
    -h, --help      Show this help

DESCRIPTION:
    Shows commit details with file statistics.
    Displays commit hash, date, author, subject, body,
    and list of changed files with modification counts.
    
    FILE STATISTICS:
    - Both standard and LLM formats: File stats shown by default
    - Use --no-stat to explicitly hide file statistics
    - Use --stat flag for explicit control (backward compatibility)

    N/-N SYNTAX CONVENTION:
    - N (0-999) → Single commit at HEAD~N (0 → HEAD)
    - -N (1-999) → Range of N commits (HEAD~N..HEAD)
    - Numbers ≥ 1000 pass through as refs

EXAMPLES:
    hug sh                  # Show last commit with stats
    hug sh 2                # Show commit two steps back (HEAD~2) with stats
    hug sh -3               # Show last 3 commits (HEAD~3..HEAD) with stats
    hug sh abc123           # Show specific commit with stats
    hug sh main..HEAD       # Show commits in range with stats
    hug sh --llm HEAD       # Show in LLM XML format WITH stats (changed default)
    hug sh --llm --no-stat HEAD # Show in LLM XML format WITHOUT stats
    hug sh --no-stat HEAD   # Show in standard format WITHOUT stats

SEE ALSO:
    hug shp      : Show commit with patch
    hug shc      : Show changed files (stats only)
    hug sl       : Show status
EOF
}

# Parse common flags (-q/--quiet, -h/--help)
eval "$(parse_common_flags "$@")"

# Parse remaining arguments
commit_ref=""
show_llm=false
show_stats_explicit=false
show_no_stat=false
for arg in "$@"; do
  case "$arg" in
  -h | --help | -q | --quiet) ;; # Already handled by parse_common_flags
  --llm)
    show_llm=true
    ;;
  --stat)
    show_stats_explicit=true
    ;;
  --no-stat)
    show_no_stat=true
    ;;
  *)
    commit_ref="$arg"
    ;;
  esac
done

# Determine output format and stats behavior
if [[ "$show_llm" == true ]]; then
  output_format="llm"
  # For LLM format: stats shown by default, hidden only if --no-stat explicitly requested
  if [[ "$show_no_stat" == true ]]; then
    show_stats=false
  elif [[ "$show_stats_explicit" == true ]]; then
    show_stats=true
  else
    show_stats=true  # Default for LLM format
  fi
else
  output_format="standard"
  # For standard format: stats shown by default, hidden only if --no-stat explicitly requested
  if [[ "$show_no_stat" == true ]]; then
    show_stats=false
  elif [[ "$show_stats_explicit" == true ]]; then
    show_stats=true
  else
    show_stats=true  # Default for standard format
  fi
fi

# Use hug-git-show library for commit display
show_commits "$commit_ref" false "$output_format" "$show_stats"

exit 0

#!/usr/bin/env bash
CMD_BASE="$(readlink -f "$0" 2>/dev/null || greadlink -f "$0")" || CMD_BASE="$0"; CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit; do . "$CMD_BASE/../lib/$f"; done # Load common constants and functions
set -euo pipefail  # Exit on error, undefined vars, pipe failures

# Part of the Hug tool suite

show_help() {
  cat <<'EOF'
hug c: Commit staged changes.

USAGE:
  hug c [OPTIONS]

OPTIONS:
  -h, --help     Show this help message and exit.
  --quiet       Suppress non-essential output.
  (All other options are passed directly to 'git commit')

DESCRIPTION:
  This command commits only the staged changes (use 'hug a' to stage files first).
  If no changes are staged, consider using 'hug ca' (commit all) instead.
  Common options include -m for a commit message, -v for verbose, etc.

EXAMPLES:
  hug a file.txt          # Stage a file
  hug c -m "Add feature"  # Commit staged file with message
  hug c -v                # Verbose commit

SEE ALSO:
  hug ca : For committing all changes to ALL tracked files (staged and unstaged)
  hug caa: For committing all changes to ALL tracked and untracked files.
  hug cm : For modifying the last commit with staged changes only.
  hug cma: For modifying the last commit with ALL tracked changes.
  hug a  : Stage tracked files, or specific files if provided.
  hug aa : Stage everything (tracked + untracked + deletions)
EOF
}

# Parse common flags
eval "$(parse_common_flags "$@")"

# Early exit if not in Git repo
check_git_repo

# Check for --allow-empty in remaining args
allow_empty=false
for arg in "$@"; do
  if [[ "$arg" == "--allow-empty" ]]; then
    allow_empty=true
    break
  fi
done

# Check for staged changes upfront
if ! $allow_empty && ! has_staged_changes; then
  info "No staged changes found.\n\nSuggestions:\n  - Stage files with 'hug a <files>' or 'hug aa' (all).\n  - To commit all changes (staged + unstaged), use 'hug ca'.\n  - For an empty commit, use 'hug c --allow-empty'.\n  - To preview staged changes, run 'hug sl' for a list or 'hug ss' for a diff."
  exit 1
fi

info "Committing staged changes..."

# Run git commit directly without capturing output to allow interactive editor
git commit "$@"

#!/usr/bin/env bash
CMD_BASE="$(readlink -f "$0" 2>/dev/null || greadlink -f "$0")" || CMD_BASE="$0"; CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit; do . "$CMD_BASE/../lib/$f"; done
set -euo pipefail  # Exit on error, undefined vars, pipe failures
# Part of the Hug tool suite

show_help() {
  cat << EOF
hug h files: Preview files touched by commits you'd rewind/back (HEAD range).

USAGE:
    hug h files [N|COMMIT] [OPTIONS]

OPTIONS:
    --stat     Show aggregate line stats per file
    -u, --upstream  Use upstream remote tip as start point (local-only commits; read-only preview)
    --quiet         Suppress output (sets HUG_QUIET=T)
    -h, --help Show this help

DESCRIPTION:
    Lists unique files changed in the range (default: last 1 commit).
    With -u, previews files in local-only commits (HEAD to upstream tip).
    Use before 'h back N' or 'h rewind COMMIT' to see affected files.

EXAMPLES:
    hug h files 3          # Files in last 3 commits
    hug h files main       # Files changed after 'main' to HEAD
    hug h files -u         # Files in local-only commits (to upstream)
    hug h files --stat     # With stats (default range)

SEE ALSO:
    h back    : Actually perform the rewind (keep staged)
    h rewind  : Destructive rewind
EOF
}

with_stat=false
upstream=false
target_arg=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) show_help; exit 0 ;;
    --stat) with_stat=true; shift ;;
    -u|--upstream) upstream=true; shift ;;
    --quiet) HUG_QUIET=T; shift ;;
    *) target_arg="$1"; shift ;;
  esac
done

if $upstream && [[ -n "$target_arg" ]]; then
  error "Cannot specify both --upstream and a target (N|COMMIT)."
fi

check_git_repo

if $upstream; then
  start_point=$(get_upstream_commit) # This will exit if no upstream
  range="$start_point..HEAD"
  local_commits=$(count_commits_in_range "$start_point" HEAD)
  if [ "$local_commits" -eq 0 ]; then
    info "No local-only commits; already synced to upstream."
    exit 0
  fi
else
  target_input="${target_arg:-}"
  target=$(resolve_head_target "$target_input" 'HEAD~1')
  start_point="$target"
  range="$start_point..HEAD"
  if ! git rev-parse --verify "$start_point" >/dev/null 2>&1; then
    error "Invalid target '${target_input:-$start_point}' (use N or commit ref)"
  fi
fi

mapfile -t files < <(list_changed_files_in_range "$start_point" HEAD)

if [ ${#files[@]} -eq 0 ]; then
  info "No files touched in range $range."
  exit 0
fi

count=${#files[@]}
if $upstream; then
  upstream_short=$(git rev-parse --short "$start_point")
  warning "These $count files are affected by $local_commits local-only commits to upstream tip $upstream_short (e.g., via 'h back -u')."
else
  warning "These $count files would be affected by moving HEAD to $start_point (e.g., via 'h back' or 'h rewind')."
fi

if $with_stat; then
  for file in "${files[@]}"; do
    stats=$(git diff --stat "$range" -- "$file" 2>/dev/null | tail -1 || echo "(no stats)")
    printf "  ${GREEN}%s${NC} %s\n" "$file" "$stats"
  done
else
  for file in "${files[@]}"; do
    printf '  %s\n' "$file"
  done
fi

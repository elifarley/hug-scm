#!/usr/bin/env bash
CMD_BASE="$(readlink -f "$0" 2> /dev/null || greadlink -f "$0")" || CMD_BASE="$0"
CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit hug-git-diff hug-git-show; do . "$CMD_BASE/../lib/$f"; done
set -euo pipefail

# Part of the Hug tool suite

show_help() {
  cat << 'EOF'
hug shcp: Show cumulative diff and file statistics for a commit or range.

USAGE:
    hug shcp [N|<commit-ref>|<range>] [OPTIONS]

ARGUMENTS:
    N               Single commit N steps back (0-999, 0 → HEAD)
    -N              Range of last N commits (1-999) → cumulative changes
    <commit-ref>    Single commit reference (default: HEAD)
    <range>         Commit range like HEAD~3..HEAD or main..feature

OPTIONS:
    -h, --help      Show this help

DESCRIPTION:
    Shows the full diff (patch) and file statistics for commits.
    Accepts a commit count, single commit, or commit range.

    For N (0-999), shows diff for commit HEAD~N (0 → HEAD).
    For -N (1-999), shows cumulative diff in last N commits.
    For single commits, shows diff for that commit.
    For ranges, shows cumulative diff across all commits in the range.

    Use 'hug shc' for stats only (no diff).

RANGE SYNTAX:
    N                 Single commit at HEAD~N (0 → HEAD)
    -N                Last N commits (shorthand for HEAD~N..HEAD)
    <start>..<end>    Changes from start (exclusive) to end (inclusive)
    main..feature     Commits in feature not in main

USE CASES FOR RANGES:
    Pre-squash review    See complete diff before squashing commits
    Branch comparison    Review all code changes between branches
    Release review       Full code audit for a release range
    Code review prep     Complete diff of multiple commits

EXAMPLES:
    hug shcp                  # Diff and stats for last commit (HEAD)
    hug shcp 1                # Diff for commit HEAD~1
    hug shcp 0                # Diff for commit HEAD
    hug shcp -3               # Cumulative diff in last 3 commits
    hug shcp abc123           # Diff for specific commit
    hug shcp HEAD~2           # Diff for commit two steps back
    hug shcp HEAD~3..HEAD     # Cumulative diff in last 3 commits (explicit)
    hug shcp main..feature    # All changes in feature branch vs main
    hug shcp v1.0.0..v1.1.0   # Diff between two tags
    
    # Related commands for different levels of detail:
    hug ll -3 --json --with-stats  # Structured commit list with stats
    hug shc -3                     # Same changes, stats only (no diff)
    hug sh                             # Commit info with brief stats
    hug shp                            # Single commit with full patch

SEE ALSO:
    hug shc      : Show changed files (stats only, no diff)
    hug sh       : Show commit info with file stats
    hug shp      : Show single commit with patch
    hug ll       : Log commits with optional JSON/stats output
    hug h files  : Preview files touched in commit range
EOF
}

# Parse arguments
case "${1:-}" in
-h | --help)
  show_help
  exit 0
  ;;
esac

commit_ref="${1:-HEAD}"

check_git_repo

# Resolve N/-N using unified N/-N syntax convention
# - N (0-999) → Single commit HEAD~N (0 → HEAD)
# - -N (1-999) → Range HEAD~N..HEAD
commit_ref=$(resolve_commit_ref "$commit_ref" "HEAD")

# Get emoji indicators
commit_emoji="$(_diff_emoji commit)"
diff_emoji="$(_diff_emoji diff)"
stats_emoji="$(_diff_emoji stats)"

# Show diff and stats
# Detect if argument is a range (contains ..) or a single commit
if [[ "$commit_ref" == *..* ]]; then
  # Range: use git diff
  printf '%s %s Cumulative diff for range %s:\n' "$commit_emoji" "$diff_emoji" "$commit_ref"
  git diff "$commit_ref"

  printf '\n%s %s Cumulative file stats:\n' "$commit_emoji" "$stats_emoji"
  HUG_QUIET=T git shc "$commit_ref"
else
  # Single commit: use git diff-tree
  printf '%s %s Diff for %s:\n' "$commit_emoji" "$diff_emoji" "$commit_ref"
  git diff-tree -p --no-commit-id -r --root "$commit_ref"

  printf '\n%s %s File stats:\n' "$commit_emoji" "$stats_emoji"
  HUG_QUIET=T git shc "$commit_ref"
fi

exit 0

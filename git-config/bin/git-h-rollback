#!/usr/bin/env bash
CMD_BASE="$(readlink -f "$0" 2>/dev/null || greadlink -f "$0")" || CMD_BASE="$0"; CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit; do . "$CMD_BASE/../lib/$f"; done
set -euo pipefail  # Exit on error, undefined vars, pipe failures
# Part of the Hug tool suite

show_help() {
    cat << EOF
hug h rollback: Make HEAD walk back some commits while DISCARDING their changes. Uncommitted changes are preserved.

USAGE:
    hug h rollback [N|COMMIT] [-u, --upstream] [--quiet] [--force]

OPTIONS:
    -u, --upstream  Sets target to upstream remote tip after read-only preview/confirmation (discards local-only commits; preserves uncommitted changes; no fetch)
    --quiet         Suppress output (sets HUG_QUIET=T)
    --force         Skip confirmation prompts (use with caution)

DESCRIPTION:
    Moves HEAD back to target. With -u, runs a read-only preview/confirmation before discarding local-only commits to sync with remote tip.

EXAMPLES:
    # Uncommitted changes are preserved in all examples below:
    hug h rollback -u         # Moves HEAD back to upstream, lose commit changes but keep local work
    hug h rollback 3          # Moves HEAD back last 3 commits
    hug h rollback a1b2c3     # Moves HEAD back after specified commit
    hug h rollback 3 --force  # Skip confirmation

SEE ALSO:
    hug h back    Make HEAD walk back some commits while keeping their changes staged
EOF
}

# Parse common flags (--quiet, --force, -h|--help)
eval "$(parse_common_flags "$@")"

# Parse custom flags
upstream=false
target_arg=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    -u|--upstream) upstream=true; shift ;;
    *) target_arg="$1"; shift ;;
  esac
done

if $upstream && [[ -n "$target_arg" ]]; then
  error "Cannot specify both --upstream and a target (N|COMMIT)."
fi

check_git_repo

if $upstream; then
  # handle_upstream_operation performs a read-only preview/confirmation and echoes the upstream commit.
  target=$(handle_upstream_operation "rolling back")
else
  target=$(resolve_head_target "${target_arg:-}" 'HEAD~1')
  handle_standard_operation "rollback" "$target"
  prompt_confirm "Rollback HEAD to $(git rev-parse --short "$target")? [y/N]: "
fi

git reset --keep "$target"
info "Roll back HEAD to $target done (uncommitted changes preserved)."

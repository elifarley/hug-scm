#!/usr/bin/env bash
# git-analyze-expert - Identify code ownership and expertise
# Part of the Hug tool suite

CMD_BASE="$(readlink -f "$0" 2>/dev/null || greadlink -f "$0")" || CMD_BASE="$0"; CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit; do . "$CMD_BASE/../lib/$f"; done
set -euo pipefail

show_help() {
  cat << 'EOF'
hug analyze expert: Identify code ownership and expertise

USAGE:
    hug analyze expert <file>|--author <name> [options]

ARGUMENTS:
    <file>            Find experts for this file
    --author <name>   Find expertise areas for author

OPTIONS:
    --since <date>     Only consider commits since date
    --decay <days>     Recency decay constant (default: 180 days = 6 months)
    --json             Output as JSON
    -h, --help         Show this help

DESCRIPTION:
    Identifies code ownership and expertise by analyzing commit history
    with recency weighting. Recent contributions count more than old ones.

    Formula: weight = commits × exp(-days_ago / decay_days)

    Ownership classification:
    - Primary: >40% weighted ownership
    - Secondary: >20% weighted ownership
    - Historical: <20% weighted ownership

    Helps answer:
    - "Who should review this file?"
    - "Who knows this code best?"
    - "What does Alice specialize in?"

EXAMPLES:
    hug analyze expert src/auth/login.js              # Experts for file
    hug analyze expert --author "Alice"               # Alice's expertise
    hug analyze expert src/auth/ --since="6m"         # Recent experts
    hug analyze expert --author "Alice" --json        # JSON output

OUTPUT FORMAT (for file):
    Experts for src/auth/login.js:

    Primary maintainer:
      Alice (45%, 23 commits, last: 2 days ago)

    Secondary:
      Bob (30%, 15 commits, last: 1 week ago)

    Historical:
      Charlie (25%, 12 commits, last: 8 months ago) ⚠️  Stale

OUTPUT FORMAT (for author):
    Alice's expertise areas:

     1. src/auth/login.js        (23 commits)
     2. src/auth/session.js      (18 commits)
     3. src/api/users.js         (15 commits)
    ...

SEE ALSO:
    hug fcon     : List all contributors to a file
    hug fa       : Count commits per author for a file
    hug lau      : Commits by specific author
EOF
}

# Parse arguments
target=""
author=""
since_arg=""
decay_days=180
json_output=false
browse_root=false

while [ $# -gt 0 ]; do
  case "$1" in
    --author)
      author="$2"
      shift 2
      ;;
    --since)
      since_arg="$2"
      shift 2
      ;;
    --decay)
      decay_days="$2"
      shift 2
      ;;
    --json)
      json_output=true
      shift
      ;;
    --browse-root)
      browse_root=true
      shift
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    *)
      target="$1"
      shift
      ;;
  esac
done

check_git_repo

# Check for Python helper
python_script="$CMD_BASE/../lib/python/ownership.py"

if [ ! -f "$python_script" ]; then
  error "Ownership analysis not available: $python_script not found"
  exit 1
fi

# Author mode
if [ -n "$author" ]; then
  py_args=(--author "$author")

  if [ -n "$since_arg" ]; then
    py_args+=(--since="$since_arg")
  fi

  if $json_output; then
    py_args+=(--format=json)
  else
    py_args+=(--format=text)
  fi

  exec python3 "$python_script" "${py_args[@]}"
fi

# File mode
if [ -z "$target" ]; then
  # Interactive file selection if gum is available
  if gum_available; then
    declare -a select_opts=("--single")

    if ! $browse_root; then
      select_opts+=("--cwd")
    fi

    select_opts+=("--prompt" "Select file for ownership analysis...")

    if ! target=$(select_files_with_status "${select_opts[@]}"); then
      info "No file selected or cancelled."
      exit 0
    fi
  else
    error "File argument required.
Usage: hug analyze expert <file>"
    exit 1
  fi
fi

# Validate file exists
if [ ! -f "$target" ]; then
  error "File not found: $target"
  exit 1
fi

# Build Python command
py_args=("$target")

if [ -n "$since_arg" ]; then
  py_args+=(--since="$since_arg")
fi

if [ "$decay_days" != "180" ]; then
  py_args+=(--decay-days="$decay_days")
fi

if $json_output; then
  py_args+=(--format=json)
else
  py_args+=(--format=text)
fi

exec python3 "$python_script" "${py_args[@]}"

#!/usr/bin/env bash
# git-analyze-co-changes - Find files that frequently change together
# Part of the Hug tool suite

CMD_BASE="$(readlink -f "$0" 2> /dev/null || greadlink -f "$0")" || CMD_BASE="$0"
CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit; do . "$CMD_BASE/../lib/$f"; done
set -euo pipefail

show_help() {
  cat << 'EOF'
hug analyze co-changes: Find files that frequently change together

USAGE:
    hug analyze co-changes [<count>] [options]

ARGUMENTS:
    <count>           Number of commits to analyze (default: 100)

OPTIONS:
    --since <date>    Only analyze commits since date
    --threshold <pct> Minimum correlation (0.0-1.0, default: 0.30)
    --top <n>         Show top N pairs (default: 20)
    --json            Output as JSON
    -h, --help        Show this help

DESCRIPTION:
    Analyzes commit history to find files that are frequently modified
    together. This helps identify:
    - Related components that should be reviewed together
    - Potential architectural coupling
    - Files to check when modifying a specific file

    Correlation formula: co_changes / min(changes_a, changes_b)
    This measures: "When the less-changed file changes, how often
    does the other file also change?"

EXAMPLES:
    hug analyze co-changes              # Last 100 commits, ≥30%
    hug analyze co-changes 200          # Last 200 commits
    hug analyze co-changes --threshold 0.50  # Only strong coupling
    hug analyze co-changes --since="1 month ago"
    hug analyze co-changes --json       # Machine-readable output

OUTPUT FORMAT:
    Co-change Analysis (last 100 commits, ≥30% correlation):

    Strong coupling (≥60%):
      src/auth/login.js ↔ src/auth/session.js
        68% correlation (23/34 commits)

    Moderate coupling (40-60%):
      src/api/users.js ↔ src/models/user.js
        54% correlation (18/33 commits)

    Interpretation:
      High correlation = Files likely architecturally coupled
      Consider: Co-locate, refactor into module, or document dependency

SEE ALSO:
    hug h files      : Files changed in commits
    hug analyze deps : Commit dependency graph
    hug stats file   : File-level statistics
EOF
}

# Parse arguments
commits=100
since_arg=""
threshold=0.30
top=20
json_output=false

while [ $# -gt 0 ]; do
  case "$1" in
  --since)
    since_arg="$2"
    shift 2
    ;;
  --threshold)
    threshold="$2"
    shift 2
    ;;
  --top)
    top="$2"
    shift 2
    ;;
  --json)
    json_output=true
    shift
    ;;
  -h | --help)
    show_help
    exit 0
    ;;
  [0-9]*)
    commits="$1"
    shift
    ;;
  *)
    error "Unknown option: $1"
    show_help
    exit 1
    ;;
  esac
done

check_git_repo

# Check for Python helper
python_script="$CMD_BASE/../lib/python/co_changes.py"

if [ ! -f "$python_script" ]; then
  error "Co-change analysis not available: $python_script not found"
  exit 1
fi

# Build git log command
git_cmd=(git log --name-only --format=%H)

if [ -n "$since_arg" ]; then
  git_cmd+=(--since="$since_arg")
else
  git_cmd+=(-n "$commits")
fi

# Build Python command
py_args=(--commits="$commits" --threshold="$threshold" --top="$top")

if $json_output; then
  py_args+=(--format=json)
else
  py_args+=(--format=text)
fi

# Execute pipeline
"${git_cmd[@]}" | python3 "$python_script" "${py_args[@]}"

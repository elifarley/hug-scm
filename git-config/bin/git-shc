#!/usr/bin/env bash
CMD_BASE="$(readlink -f "$0" 2> /dev/null || greadlink -f "$0")" || CMD_BASE="$0"
CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit hug-git-diff hug-git-show; do . "$CMD_BASE/../lib/$f"; done
set -euo pipefail

# Part of the Hug tool suite

show_help() {
  cat << 'EOF'
hug shc: Show files changed in a commit or range with statistics.

USAGE:
    hug shc [N|<commit-ref>|<range>] [OPTIONS]

ARGUMENTS:
    N               Single commit N steps back (0-999, 0 → HEAD)
    -N              Range of last N commits (1-999) → cumulative changes
    <commit-ref>    Single commit reference (default: HEAD)
    <range>         Commit range like HEAD~3..HEAD or main..feature

OPTIONS:
    -q, --quiet     Suppress header line (also honors HUG_QUIET env var)
    -h, --help      Show this help

DESCRIPTION:
    Lists files changed with addition/deletion counts.
    Accepts a commit count, single commit, or commit range.

    For N (0-999), shows files changed in commit HEAD~N (0 → HEAD).
    For -N (1-999), shows cumulative file changes in last N commits.
    For single commits, shows files changed in that commit.
    For ranges, shows cumulative file changes across all commits in the range.

    This command is the canonical source for file statistics display.
    It is used internally by other Hug commands (sh, shp, shcp, h files,
    h squash, lol, cmv) via HUG_QUIET=T to provide consistent stats output.

    Use 'hug sh' for full commit details including message.

RANGE SYNTAX:
    N                 Single commit at HEAD~N (0 → HEAD)
    -N                Last N commits (shorthand for HEAD~N..HEAD)
    <start>..<end>    Changes from start (exclusive) to end (inclusive)
    main..feature     Commits in feature not in main

USE CASES FOR RANGES:
    Pre-squash review    See cumulative impact before squashing commits
    Branch comparison    Compare total changes between branches
    Release review       Audit all changes in a release range
    Code review prep     Understand scope of multiple commits

EXAMPLES:
    hug shc                  # Files changed in last commit (HEAD)
    hug shc 1                # Files changed in commit HEAD~1
    hug shc 0                # Files changed in commit HEAD
    hug shc -3               # Cumulative changes in last 3 commits
    hug shc abc123           # Files changed in specific commit
    hug shc HEAD~2           # Files changed two commits ago
    hug shc HEAD~3..HEAD     # Cumulative changes in last 3 commits (explicit)
    hug shc main..feature    # All changes in feature branch vs main
    hug shc v1.0.0..v1.1.0   # Changes between two tags

SEE ALSO:
    hug sh       : Show commit info with file stats
    hug shp      : Show commit with patch and stats
    hug shcp     : Show cumulative diff and stats for range
    hug h files  : Preview files touched in commit range
    hug h squash : Squash commits (uses shc for preview)
    hug lol      : Preview outgoing commits with stats
    hug cmv      : Move commits between branches
EOF
}

# Parse common flags (-q/--quiet, -h/--help)
eval "$(parse_common_flags "$@")"

# Parse remaining arguments
commit_ref=""
for arg in "$@"; do
  case "$arg" in
  -h | --help | -q | --quiet) ;; # Already handled by parse_common_flags
  *)
    commit_ref="$arg"
    ;;
  esac
done

commit_ref="${commit_ref:-HEAD}"

check_git_repo

# Resolve N/-N using unified N/-N syntax convention
# - N (0-999) → Single commit HEAD~N (0 → HEAD)
# - -N (1-999) → Range HEAD~N..HEAD
commit_ref=$(resolve_commit_ref "$commit_ref" "HEAD")

# Show changed files with stats
# Detect if argument is a range (contains ..) or a single commit
if [[ "$commit_ref" == *..* ]]; then
  # Range: use git diff --stat
  if [[ ${HUG_QUIET:-} != T ]]; then
    commit_emoji="$(_diff_emoji commit)"
    stats_emoji="$(_diff_emoji stats)"
    printf '%s %s Changed files in range %s:\n' "$commit_emoji" "$stats_emoji" "$commit_ref"
  fi
  git diff --stat "$commit_ref"
else
  # Single commit: use git diff-tree
  if [[ ${HUG_QUIET:-} != T ]]; then
    commit_emoji="$(_diff_emoji commit)"
    stats_emoji="$(_diff_emoji stats)"
    printf '%s %s Changed files:\n' "$commit_emoji" "$stats_emoji"
  fi
  git diff-tree --no-commit-id --stat -r --root "$commit_ref"
fi

exit 0

#!/usr/bin/env bash
CMD_BASE="$(readlink -f "$0" 2>/dev/null || greadlink -f "$0")" || CMD_BASE="$0"; CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit; do . "$CMD_BASE/../lib/$f"; done
set -euo pipefail  # Exit on error, undefined vars, pipe failures
# Part of the Hug tool suite

show_help() {
    cat << EOF
hug h rewind: Moves HEAD back, discarding their changes AND uncommitted changes.

USAGE:
    hug h rewind [N|COMMIT] [-u, --upstream] [--quiet]

OPTIONS:
    -u, --upstream  Sets target to upstream remote tip after read-only preview/confirmation (discards everything after remote tip; no fetch)
    --quiet         Suppress output (sets HUG_QUIET=T)

DESCRIPTION:
    Moves HEAD back to target (full clean). With -u, runs a read-only preview/confirmation before discarding local-only commits and uncommitted changes to sync with remote tip.

EXAMPLES:
    hug h rewind -u              # Moves HEAD back to upstream, WD loses all changes
    hug h rewind 3               # Moves HEAD back last 3 commits
    hug h rewind a1b2c3          # Moves HEAD back after specified commit

SEE ALSO:
    hug h back    Move HEAD back, keep changes staged
EOF
}

upstream=false
target_arg=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) show_help; exit 0 ;;
    -u|--upstream) upstream=true; shift ;;
    --quiet) HUG_QUIET=T; shift ;;
    *) target_arg="$1"; shift ;;
  esac
done

if $upstream && [[ -n "$target_arg" ]]; then
  error "Cannot specify both --upstream and a target (N|COMMIT)."
fi

check_git_repo

if $upstream; then
  # handle_upstream_operation performs a read-only preview/confirmation and echoes the upstream commit.
  target=$(handle_upstream_operation "rewinding" "rewind" "rewind to upstream and discard all commits/uncommitted changes after it")
else
  target=$(resolve_head_target "${target_arg:-}" 'HEAD~1')

  printf 'Will rewind to %s and discard all commits after it\n' "$target" >&2
  printf 'Commits to be discarded:\n' >&2
  print_commit_list_in_range "$target" HEAD >&2
  printf '\n' >&2

  printf '⚠️  This is PERMANENT and cannot be undone!\n' >&2
  read -p 'Type "rewind" to confirm: ' confirm >&2
  [ "$confirm" = "rewind" ] || { info "Cancelled."; exit 1; }
fi

printf 'Rewinding to %s...\n' "$target" >&2
git reset --hard "$target"
printf 'Rewind complete. Repository is now at %s\n' "$(git rev-parse --short "$target")" >&2

#!/usr/bin/env bash
CMD_BASE="$(readlink -f "$0" 2>/dev/null || greadlink -f "$0")" || CMD_BASE="$0"; CMD_BASE="$(dirname "$CMD_BASE")"
for f in hug-common hug-git-kit output_json_branch_list; do . "$CMD_BASE/../lib/$f"; done # Load common constants and functions
set -euo pipefail  # Exit on error, undefined vars, pipe failures

# Part of the Hug tool suite

show_help() {
  cat <<'EOF'
hug bll: List local branches in long format, showing short hash, upstream tracking info, and commit message title for each.

USAGE:
  hug bll [OPTIONS] [SEARCH_TERM]

OPTIONS:
  -h, --help     Show this help message and exit.
  --json         Output in JSON format instead of human-readable text.

DESCRIPTION:
  Displays each local branch sorted alphabetically. The current branch is highlighted in green and marked with an asterisk (*).
  Each entry shows: branch name (short hash) [upstream tracking info, e.g., origin/main ahead 2].
  The commit message title follows.
  Remote tracking information is shown just as in 'git branch -vv'.

  If a search term is provided, only branches containing the term (case-insensitive substring match on branch name) are displayed.

EXAMPLES:
  hug bll          # List all local branches in long format
  hug bll fix      # List branches containing "fix"

SEE ALSO:
  hug bl : For listing local branches in short form
  hug b  : For switching branches
EOF
}

# Parse arguments
json_output=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    --json)
      json_output=true
      shift
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    *)
      # Treat remaining arguments as search terms
      break
      ;;
  esac
done

# Capture search terms
search_terms="$*"

# Early exit if not in Git repo
check_git_repo

# JSON output mode
if $json_output; then
  # Get current branch for JSON
  current_branch=$(git branch --show-current 2>/dev/null || echo "detached HEAD")
  output_json_branch_list "$current_branch"
  exit 0
fi

# Compute branch details using batched operations for performance
declare -a branches=() hashes=() subjects=() tracks=()
max_len=""
current_branch=""
if ! compute_local_branch_details_batched current_branch max_len hashes branches tracks subjects true; then
  printf "No local branches found.\n" >&2
  exit 1
fi

# Print non-interactive list
print_branch_list "$current_branch" "$max_len" hashes branches tracks subjects "$search_terms"

# shellcheck shell=bash
# Library: HUG CLI flag parsing utilities
#
# Shared argument parsing and validation helpers for hug commands.
# Depends on: hug-output for consistent error reporting.
# Functions:
#   - parse_common_flags: expand shared flags into shell assignments.
#   - require_args: enforce minimum argument counts.

################################################################################
# Command Pattern Helpers
################################################################################

# Parses common option flags for command scripts
# Usage: eval "$(parse_common_flags "$@")"
# Recognizes flags:
#   --dry-run    Sets dry_run=true
#   -f, --force  Sets force=true, exports HUG_FORCE=true
#   --quiet      Exports HUG_QUIET=T
#   -h, --help   Calls usage or show_help function and exits
#   --           If last argument, sets HUG_INTERACTIVE_FILE_SELECTION=true and removes it
# Note:
#   Consumes recognized flags from arguments
#   Remaining args can be accessed via "$@" after eval
#   Handles empty remaining args without setting $@ to ("")
parse_common_flags() {
  local remaining_args=()
  local interactive_file_selection=false
  
  # Check if last argument is '--' before processing
  if [[ $# -gt 0 && "${!#}" = "--" ]]; then
    interactive_file_selection=true
    # Remove last argument by creating new array without it
    set -- "${@:1:$(($#-1))}"
  fi
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run)
        echo "dry_run=true"
        shift
        ;;
      -f|--force)
        echo "force=true"
        echo "export HUG_FORCE=true"
        shift
        ;;
      --quiet)
        echo "export HUG_QUIET=T"
        shift
        ;;
      -h|--help)
        echo "if declare -f show_help >/dev/null; then show_help; fi; exit 0"
        shift
        ;;
      --)
        shift
        remaining_args+=("$@")
        break
        ;;
      *)
        remaining_args+=("$1")
        shift
        ;;
    esac
  done
  
  # Export interactive file selection flag if detected
  if $interactive_file_selection; then
    echo "export HUG_INTERACTIVE_FILE_SELECTION=true"
  fi
  
  # Always output set -- to properly update $@ in the caller
  if [ ${#remaining_args[@]} -gt 0 ]; then
    printf 'set -- '
    printf '%q ' "${remaining_args[@]}"
    printf '\n'
  else
    printf 'set --\n'
  fi
}

# Validates minimum number of arguments
# Usage: require_args N ["error message"]
# Parameters:
#   $1 - Minimum number of arguments required
#   $2 - (Optional) Custom error message
# Environment:
#   Uses $# from caller's context
# Note:
#   This is meant to be called with: require_args N "$#" ["message"]
require_args() {
  local required="$1"
  local actual="$2"
  local message="${3:-this command requires at least $required argument(s)}"
  
  if [[ $actual -lt $required ]]; then
    error "$message"
  fi
}


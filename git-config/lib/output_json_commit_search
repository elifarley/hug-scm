#!/usr/bin/env bash
# Helper function for JSON commit search output
# Usage: output_json_commit_search "type" "search_term" "with_files" [additional_args]

# Load JSON utilities
CMD_BASE="$(readlink -f "$0" 2>/dev/null || greadlink -f "$0")" || CMD_BASE="$0"; CMD_BASE="$(dirname "$CMD_BASE")"
. "$CMD_BASE/../lib/hug-json"

output_json_commit_search() {
  local search_type="$1"
  local search_term="$2"
  local with_files="$3"
  shift 3

  # Build git log command based on search type
  local -a git_log_args=()
  case "$search_type" in
    "message")
      git_log_args+=("--grep=$search_term")
      ;;
    "code")
      git_log_args+=("-S$search_term")
      ;;
    *)
      json_error "invalid_search_type" "Search type must be 'message' or 'code'"
      ;;
  esac

  # Add additional args
  git_log_args+=("$@")

  # Build format string for parsing
  local format_string="%H%n%h%n%an%n%ae%n%ai%n%s"
  if $with_files; then
    format_string+="%n%b"  # Add body for file extraction
  fi

  # Execute git log and parse results
  local -a commits=()
  while IFS=$'\n' read -r hash short_hash author_name author_email date subject; do
    [[ -z "$hash" ]] && continue

    # Build commit object
    local commit_object
    commit_object=$(to_json_object \
      "sha" "$hash" \
      "sha_short" "$short_hash" \
      "author" "$(to_json_object "name" "$author_name" "email" "$author_email")" \
      "date" "$date" \
      "message" "$subject")

    # Add files if requested
    if $with_files; then
      # Read body (which contains file info when using --name-status)
      local body
      local files_array="[]"

      # Get file list for this commit
      local -a file_objects=()
      while IFS= read -r file_line; do
        [[ -z "$file_line" ]] && continue
        local status file_path
        status=$(echo "$file_line" | cut -c1)
        file_path=$(echo "$file_line" | cut -c2-)

        local status_type
        case "$status" in
          A) status_type="added" ;;
          M) status_type="modified" ;;
          D) status_type="deleted" ;;
          R*) status_type="renamed" ;;
          C*) status_type="copied" ;;
          *) status_type="unknown" ;;
        esac

        file_objects+=("$(to_json_object "path" "$file_path" "status" "$status_type")")
      done < <(git show --name-status --format="" "$hash" 2>/dev/null | tail -n +2)

      if [[ ${#file_objects[@]} -gt 0 ]]; then
        files_array="[$(IFS=','; echo "${file_objects[*]}")]"
      fi

      commit_object="${commit_object%,}"  # Remove closing brace
      commit_object+=",\"files\":$files_array}"
    fi

    commits+=("$commit_object")
  done < <(git log --format="$format_string" "${git_log_args[@]}")

  # Build search metadata
  local search_metadata
  search_metadata=$(to_json_object \
    "type" "$search_type" \
    "term" "$search_term" \
    "with_files" "$with_files" \
    "results_count" "${#commits[@]}")

  # Build final JSON output
  local json_output
  json_output=$(to_json_object \
    "repository" "$(pwd)" \
    "timestamp" "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
    "command" "hug lf --json" \
    "version" "${HUG_VERSION:-unknown}" \
    "search" "$search_metadata" \
    "results" "[$(IFS=','; echo "${commits[*]}")]")

  printf '%s\n' "$json_output"
}
#!/usr/bin/env bash
# Helper function for JSON status output
# Used by git-statusbase command

# Load JSON utilities
CMD_BASE="$(readlink -f "$0" 2>/dev/null || greadlink -f "$0")" || CMD_BASE="$0"; CMD_BASE="$(dirname "$CMD_BASE")"
. "$CMD_BASE/../lib/hug-json"

output_json_status() {
  local include_staged=false
  local include_unstaged=false
  local include_untracked=false
  local include_ignored=false
  local scope_cwd=false

  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --staged)
        include_staged=true
        shift
        ;;
      --unstaged)
        include_unstaged=true
        shift
        ;;
      --untracked)
        include_untracked=true
        shift
        ;;
      --ignored)
        include_ignored=true
        shift
        ;;
      --cwd)
        scope_cwd=true
        shift
        ;;
      *)
        shift
        ;;
    esac
  done

  # Build flag array for list functions
  local -a list_flags=()
  if $scope_cwd; then
    list_flags+=("--cwd")
  fi

  # Collect files based on requested types
  local -a staged_files=()
  local -a unstaged_files=()
  local -a untracked_files=()
  local -a ignored_files=()

  if $include_staged; then
    local -a status_flags=("${list_flags[@]}" "--status")
    while IFS= read -r line; do
      [[ -z "$line" ]] && continue
      local status file additions deletions
      IFS=$'\t' read -r status file additions deletions <<< "$line"

      local status_type
      case "$status" in
        A)  status_type="added" ;;
        M)  status_type="modified" ;;
        D)  status_type="deleted" ;;
        R*) status_type="renamed" ;;
        C*) status_type="copied" ;;
        U)  status_type="conflict" ;;
        *)  status_type="unknown" ;;
      esac

      staged_files+=("$(to_json_object "path" "$file" "status" "$status_type" "additions" "${additions:-0}" "deletions" "${deletions:-0}")")
    done < <(list_staged_files "${status_flags[@]}")
  fi

  if $include_unstaged; then
    local -a status_flags=("${list_flags[@]}" "--status")
    while IFS= read -r line; do
      [[ -z "$line" ]] && continue
      local status file additions deletions
      IFS=$'\t' read -r status file additions deletions <<< "$line"

      local status_type
      case "$status" in
        M)  status_type="modified" ;;
        D)  status_type="deleted" ;;
        U)  status_type="conflict" ;;
        *)  status_type="unknown" ;;
      esac

      unstaged_files+=("$(to_json_object "path" "$file" "status" "$status_type" "additions" "${additions:-0}" "deletions" "${deletions:-0}")")
    done < <(list_unstaged_files "${status_flags[@]}")
  fi

  if $include_untracked; then
    mapfile -t files < <(list_untracked_files "${list_flags[@]}")
    for file in "${files[@]}"; do
      [[ -z "$file" ]] && continue
      untracked_files+=("$(to_json_object "path" "$file" "status" "untracked")")
    done
  fi

  if $include_ignored; then
    mapfile -t files < <(list_ignored_files "${list_flags[@]}")
    for file in "${files[@]}"; do
      [[ -z "$file" ]] && continue
      ignored_files+=("$(to_json_object "path" "$file" "status" "ignored")")
    done
  fi

  # Build summary
  local summary
  summary=$(to_json_object \
    "staged" "${#staged_files[@]}" \
    "unstaged" "${#unstaged_files[@]}" \
    "untracked" "${#untracked_files[@]}" \
    "ignored" "${#ignored_files[@]}" \
    "total" "$((${#staged_files[@]} + ${#unstaged_files[@]} + ${#untracked_files[@]} + ${#ignored_files[@]}))")

  # Build summary object
  local summary_object
  summary_object=$(to_json_object \
    "staged" "${#staged_files[@]}" \
    "unstaged" "${#unstaged_files[@]}" \
    "untracked" "${#untracked_files[@]}" \
    "ignored" "${#ignored_files[@]}" \
    "total" "$((${#staged_files[@]} + ${#unstaged_files[@]} + ${#untracked_files[@]} + ${#ignored_files[@]}))")

  # Start JSON output
  local json
  json=$(to_json_object \
    "repository" "$(pwd)" \
    "timestamp" "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
    "command" "hug status --json" \
    "version" "${HUG_VERSION:-unknown}" \
    "summary" "$summary_object")

  # Add files arrays - only include non-empty arrays
  local files_added=false
  if $include_staged && [ ${#staged_files[@]} -gt 0 ]; then
    json+=",\"staged\":[$(IFS=','; echo "${staged_files[*]}")]"
    files_added=true
  fi
  if $include_unstaged && [ ${#unstaged_files[@]} -gt 0 ]; then
    json+=",\"unstaged\":[$(IFS=','; echo "${unstaged_files[*]}")]"
    files_added=true
  fi
  if $include_untracked && [ ${#untracked_files[@]} -gt 0 ]; then
    json+=",\"untracked\":[$(IFS=','; echo "${untracked_files[*]}")]"
    files_added=true
  fi
  if $include_ignored && [ ${#ignored_files[@]} -gt 0 ]; then
    json+=",\"ignored\":[$(IFS=','; echo "${ignored_files[*]}")]"
    files_added=true
  fi

  printf '%s\n' "$json"
}
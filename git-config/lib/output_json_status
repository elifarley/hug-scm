#!/usr/bin/env bash
# Helper function for JSON status output
# Used by git-statusbase command

# Load JSON utilities
CMD_BASE="$(readlink -f "$0" 2> /dev/null || greadlink -f "$0")" || CMD_BASE="$0"
CMD_BASE="$(dirname "$CMD_BASE")"
. "$CMD_BASE/../lib/hug-json"

output_json_status() {
  local include_staged=false
  local include_unstaged=false
  local include_untracked=false
  local include_ignored=false
  local scope_cwd=false

  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
    --staged)
      include_staged=true
      shift
      ;;
    --unstaged)
      include_unstaged=true
      shift
      ;;
    --untracked)
      include_untracked=true
      shift
      ;;
    --ignored)
      include_ignored=true
      shift
      ;;
    --cwd)
      scope_cwd=true
      shift
      ;;
    *)
      shift
      ;;
    esac
  done

  # Load unified JSON library
  . "$CMD_BASE/../lib/hug-git-json"

  # Build filter types
  local filter_types=""
  if $include_staged; then
    filter_types+="staged,"
  fi
  if $include_unstaged; then
    filter_types+="unstaged,"
  fi
  if $include_untracked; then
    filter_types+="untracked,"
  fi
  if $include_ignored; then
    filter_types+="ignored,"
  fi

  # Remove trailing comma if any
  filter_types="${filter_types%,}"

  # Build unified arguments (library version excludes empty arrays)
  local -a unified_args=()

  if [[ -n "$filter_types" ]]; then
    unified_args+=("--filter" "$filter_types")
  fi

  if $scope_cwd; then
    unified_args+=("--cwd-only")
  fi

  # Call unified function
  output_json_status_unified "${unified_args[@]}"
}
